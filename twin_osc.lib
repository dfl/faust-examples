// twin_osc.lib
// TwinOsc Library - Time-Varying Comb Filter Synthesis
//
// Based on: "Virtual Analog Synthesis with a Time-Varying Comb Filter"
// D. Lowenfels, AES Convention 115, October 2003
// https://www.researchgate.net/publication/325654284
//
// Usage:
//   import("twin_osc.lib");
//   process = to_twin_osc(freq, amt, detune, mode);

declare name "TwinOsc Library";
declare author "David Lowenfels <dfl>";
declare version "1.0";
declare reference "https://www.researchgate.net/publication/325654284";

import("stdfaust.lib");

//=============================================================================
// Antialiased Sawtooth
//=============================================================================

to_saw(f) = os.sawtooth(f);

//=============================================================================
// Hermite Interpolation Delay
//=============================================================================
// 4-point 3rd-order Lagrange interpolation for smooth fractional delay

to_hermite_delay(maxdelay, d, x) = de.fdelaylti(4, maxdelay, d, x);

//=============================================================================
// Helpers
//=============================================================================

to_select3(s, a, b, c) = select2(s > 0, a, select2(s > 1, b, c));

//=============================================================================
// Delay Calculation
//=============================================================================
// Converts PWM amount (0-1) to delay in samples
// amt=0.5 gives half-period delay (square wave in PWM mode)

to_calc_delay(f, amt, detune) = base_delay * ma.SR / f + detune
with {
    base_delay = amt * 0.5;
};

to_MAX_DELAY = 4096;

//=============================================================================
// Twin Oscillator (Time-Varying Comb Filter)
//=============================================================================
// Sawtooth through feedforward comb filter: y = x - g*x[n-d]
//
// Modes (comb filter configurations):
//   0 = PWM:    y = x - x[d]     Feedforward comb → pulse width modulation
//   1 = MORPH:  y = x - g*x[d]   Scaled comb → saw to square morphing
//   2 = DETUNE: y = x + x[d]     Summing comb (note: handled separately in DSP)
//
// Parameters:
//   f      - frequency in Hz
//   amt    - effect amount (0-1), controls comb delay time
//   detune - additional delay offset in samples
//   m      - mode selector (0, 1, or 2)

to_twin_osc(f, amt, detune, m) = output
with {
    osc_out = to_saw(f);
    delay_samples = max(0.01, to_calc_delay(f, amt, detune));
    delayed = to_hermite_delay(to_MAX_DELAY, delay_samples, osc_out);

    pwm_out = osc_out - delayed;
    morph_out = osc_out - amt * delayed;
    detune_out = osc_out + delayed;

    output = to_select3(m, pwm_out, morph_out, detune_out);
};
