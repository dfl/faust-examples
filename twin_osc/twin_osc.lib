//############### twin_osc.lib #################################################
// TwinOsc Library - Time-Varying Comb Filter Tricks
//
// Based on: "Virtual Analog Synthesis with a Time-Varying Comb Filter"
// D. Lowenfels, AES Convention 115, October 2003
//
// A sawtooth oscillator fed through a modulated comb filter (delay line)
// creates classic analog effects: PWM, saw-to-square morphing, and detune.
//
// #### Usage
//
// ```
// dfl = library("twin_osc.lib");
// process = dfl.osc(freq, amt, detune, mode);
// ```
//
// #### Reference
//
// * <https://www.researchgate.net/publication/325654284>
//##############################################################################

declare name "TwinOsc Library";
declare author "David Lowenfels";
declare license "MIT";
declare version "1.0";

import("stdfaust.lib");

//================================ Constants ===================================
//==============================================================================

MAX_DELAY = 4096;

//=============================== Utilities ====================================
//==============================================================================

//------------------------`(dfl).fdelay4`---------------------------------------
// 4-point Lagrange interpolation fractional delay.
//
// #### Usage
//
// ```
// _ : dfl.fdelay4(maxdelay, delay) : _
// ```
//
// Where:
//
// * `maxdelay`: maximum delay in samples (compile-time constant)
// * `delay`: current delay in samples
//------------------------------------------------------------------------------
fdelay4(maxdelay, d, x) = de.fdelaylti(4, maxdelay, d, x);

//============================= Twin Oscillator ================================
//==============================================================================

//------------------------`(dfl).osc`-------------------------------------------
// Twin oscillator using time-varying comb filter.
// Sawtooth through feedforward comb filter: `y = x - g*x[n-d]`
//
// Modes (comb filter configurations):
//
// * 0 = PWM: `y = x - x[d]` - pulse width modulation
// * 1 = MORPH: `y = x - amt*x[d]` - saw to square morphing
// * 2 = DETUNE: `y = x + x[d]` - summing comb
//
// #### Usage
//
// ```
// dfl.osc(freq, amt, detune, mode) : _
// ```
//
// Where:
//
// * `freq`: frequency in Hz
// * `amt`: effect amount (0-1), controls comb delay time
// * `detune`: additional delay offset in samples
// * `mode`: mode selector (0=PWM, 1=MORPH, 2=DETUNE)
//------------------------------------------------------------------------------
osc(f, amt, detune, m) = output
with {
    osc_out = os.sawtooth(f);
    delay_samples = max(0.01, calc_delay(f, amt, detune));
    delayed = fdelay4(MAX_DELAY, delay_samples, osc_out);

    pwm_out = osc_out - delayed;
    morph_out = osc_out - amt * delayed;
    detune_out = osc_out + delayed;

    output = select3(m, pwm_out, morph_out, detune_out);
};

//------------------------`calc_delay`------------------------------------------
// Internal: converts PWM amount (0-1) to delay in samples.
// amt=0.5 gives half-period delay (square wave in PWM mode).
//------------------------------------------------------------------------------
calc_delay(f, amt, detune) = base_delay * ma.SR / f + detune
with {
    base_delay = amt * 0.5;
};
