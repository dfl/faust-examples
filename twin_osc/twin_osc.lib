//############### twin_osc.lib #################################################
// TwinOsc Library - Time-Varying Comb Filter Oscillator and Pitch Shifter
//
// Based on: "Virtual Analog Synthesis with a Time-Varying Comb Filter"
// D. Lowenfels, AES Convention 115, October 2003
//
// A sawtooth oscillator fed through a modulated comb filter (delay line)
// creates classic analog effects: PWM, saw-to-square morphing, and detune.
//
// #### Usage
//
// ```
// dfl = library("twin_osc.lib");
// process = dfl.twin_osc(freq, amt, detune, mode);
// process = _ : dfl.doppler_shift(freq, ratio) : _;
// ```
//
// #### Reference
//
// * <https://www.researchgate.net/publication/325654284>
//##############################################################################

declare name "TwinOsc Library";
declare author "David Lowenfels";
declare license "MIT";
declare version "1.0";

import("stdfaust.lib");

//------------------------------`(dfl.)twin_osc`--------------------------------
// Twin oscillator using a time-varying comb filter for PWM, morph, or detune.
// Sawtooth through feedforward comb filter: `y = x - g*x[n-d]`
//
// Modes (comb filter configurations):
//
// * 0 = PWM: `y = x - x[d]` - pulse width modulation
// * 1 = MORPH: `y = x - amt*x[d]` - saw to square morphing
// * 2 = DETUNE: `y = x + x[d]` - summing comb
//
// #### Usage
//
// ```
// twin_osc(freq, amt, detune, mode) : _
// ```
//
// Where:
//
// * `freq`: frequency in Hz
// * `amt`: effect amount (0-1), controls comb delay time
// * `detune`: additional delay offset in samples
// * `mode`: mode selector (0=PWM, 1=MORPH, 2=DETUNE)
//
// #### References
//
// * <https://www.researchgate.net/publication/325654284>
//----------------------------------------------------------------

twin_osc(f, amt, detune, m) = output
with {
    MAX_DELAY = 4096;
    osc_out = os.sawtooth(f);
    delay_samples = max(0.01, amt * 0.5 * ma.SR / f + detune);
    delayed = de.fdelaylti(4, MAX_DELAY, delay_samples, osc_out);

    pwm_out = osc_out - delayed;
    morph_out = osc_out - amt * delayed;
    detune_out = osc_out + delayed;

    output = select3(m, pwm_out, morph_out, detune_out);
};

//------------------------------`(dfl.)doppler_shift`---------------------------
// Pitch shifter for signals with known fundamental frequency.
// Uses Doppler effect from a continuously ramping delay line,
// with phase-coherent phasor reset synced to the signal period.
// Best suited for harmonic/periodic signals like oscillator outputs.
//
// #### Usage
//
// ```
// _ : doppler_shift(freq, ratio) : _
// ```
//
// Where:
//
// * `freq`: fundamental frequency of the input signal (Hz)
// * `ratio`: pitch ratio (1.0 = no shift, 2.0 = octave up, 0.5 = octave down)
//
// #### References
//
// * <https://www.researchgate.net/publication/325654284>
//----------------------------------------------------------------

doppler_shift(freq, ratio, sig) = de.fdelaylti(4, MAX_DELAY, delay_samples, sig)
with {
    MAX_DELAY = 4096;
    period_samples = ma.SR / freq;
    phasor_freq = freq * (ratio - 1);
    phasor = os.phasor(1, phasor_freq);
    delay_samples = (2 - phasor) * period_samples;
};
